# Polkit-CVE-2021-3560


## Background

In early 2021 a researcher named Kevin Backhouse discovered a seven year old privilege escalation vulnerability (since designated CVE-2021-3560) in the Linux polkit utility. Fortunately, different distributions of Linux (and even different versions of the same distributions) use different versions of the software, meaning that only some are vulnerable.

Specifically, the following mainstream distributions, amongst others, were vulnerable:

Red Hat Enterprise Linux 8
Fedora 21 (or later)
Debian Testing ("Bullseye")
Ubuntu 20.04 LTS ("Focal Fossa")
All should now have released patched versions of their respective polkit packages, however, if you encounter one of these distributions then it may still be vulnerable if it hasn't been updated for a while.

For this room we will be focussing specifically on Ubuntu 20.04. Canonical released a patch for their version of polkit ```(policykit-1)```, which has version number ```0.105-26ubuntu1.1```. The last vulnerable version available in the apt repositories for Focal Fossa is ```0.105-26ubuntu1```, so, if you see this, you may be in luck!

We can use ```apt list --installed | grep policykit-1``` to check the installed version of polkit:


## What is Polkit?

The logical question to be asking right now is: "What is polkit?"

Polkit is part of the Linux authorisation system. In effect, when you try to perform an action which requires a higher level of privileges, the policy toolkit can be used to determine whether you have the requisite permissions. It is integrated with systemd and is much more configurable than the traditional sudo system. Indeed, it is sometimes referred to as the "sudo of systemd".


## Vunerability 

- The attacker manually sends a dbus message to the accounts-daemon requesting the creation of a new account with sudo permissions (or latterly, a password to be set for the new user). This message gets given a unique ID by the dbus-daemon.
- The attacker kills the message after polkit receives it, but before polkit has a chance to process the message. This effectively destroys the unique message ID.
- Polkit asks the dbus-daemon for the user ID of the user who sent the message, referencing the (now deleted) message ID.
- The dbus-daemon can't find the message ID because we killed it in step two. It handles the error by responding with an error code.
- Polkit mishandles the error and substitutes in 0 for the user ID -- i.e. the root account of the machine.
- Thinking that the root user requested the action, polkit allows the request to go through unchallenged.










## Reference
https://github.blog/2021-06-10-privilege-escalation-polkit-root-on-linux-with-bug/
https://github.blog/2021-06-10-privilege-escalation-polkit-root-on-linux-with-bug/#about
